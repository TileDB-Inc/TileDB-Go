name: TileDB-Go with nightly libtiledb

on:
  push:
    paths:
      - '.github/workflows/nightly.yml'
      - '.github/scripts/nightly/**'
  pull_request:
    paths:
      - '.github/workflows/nightly.yml'
      - '.github/scripts/nightly/**'
  schedule:
    - cron: "0 4 * * *" # Every night at 4 AM UTC (11 PM EST; 12 AM EDT)
  workflow_dispatch:

env:
  go: "1.18"

jobs:
  # Quick build using nightly libtiledb installed as conda binary
  # https://anaconda.org/tiledb/tiledb/files?channel=nightlies
  # https://github.com/TileDB-Inc/conda-forge-nightly-controller
  ubuntu:
    runs-on: ubuntu-20.04
    defaults:
      run:
        shell: bash -l {0}
    steps:

    - uses: actions/checkout@v3

    - name: Install Conda environment with go and nightly libtiledb
      uses: mamba-org/provision-with-micromamba@main
      with:
        environment-file: false
        environment-name: nightly
        extra-specs: |
          gcc
          go=${{ env.go }}
          tiledb
        channels: tiledb/label/nightlies, conda-forge

    - name: Install dependencies
      run: go get -t .

    - name: Test TileDB-Go
      run: |
        export CPATH=$CONDA_PREFIX/include
        export LIBRARY_PATH=$CONDA_PREFIX/lib
        export LD_LIBRARY_PATH=$CONDA_PREFIX/lib

        go test -v ./...

  # Longer build because libtiledb is built from source
  #
  # Couldn't build against the conda binary on macOS. When I set
  # `DYLD_LIBRARY_PATH=$CONDA_PREFIX/lib`, then it failed because it found the
  # system libarchive instead of the conda-installed one (even when I explicitly
  # installed it from conda-forge). Error message below:
  #
  # dyld: Symbol not found: _iconv
  #   Referenced from: /usr/lib/libarchive.2.dylib
  #   Expected in: /Users/runner/micromamba-root/envs/nightly/lib/libiconv.2.dylib
  #   in /usr/lib/libarchive.2.dylib
  macos:
    runs-on: macos-11
    needs: ubuntu
    steps:

    - uses: actions/checkout@v3
      with:
        repository: 'TileDB-Inc/TileDB-Go'
        ref: 'sa/sc-24303/not-use-deprecated-tiledb-methods'

    - name: Install nightly TileDB from source
      run: ./.github/scripts/nightly/install_tiledb_source_macos.sh

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: ${{ env.go }}

    - name: Install dependencies
      run: go get -t .

    - name: Test TileDB-Go
      run: go test -v ./...

  # Report if either the Ubuntu or macOS builds fail
  #
  # If there is an existing "nightly-failure" Issue open, then it comments
  # instead of creating a new one
  #
  # Only reports a failure for scheduled builds on the TileDB-Inc repo
  issue:
    permissions:
      issues: write
    runs-on: ubuntu-latest
    needs: [ubuntu, macos]
    if: ( failure() || cancelled() ) && github.repository_owner == 'TileDB-Inc' && github.event_name == 'schedule'
    steps:

    - uses: actions/checkout@v3
    - name: Open Issue
      env:
        GH_TOKEN: ${{ github.token }}
        TZ: "America/New_York"
      run: ./.github/scripts/nightly/open-isue.sh
